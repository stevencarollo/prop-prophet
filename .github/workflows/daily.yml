name: Prophet Cloud Automation

on:
  schedule:
    # 8:00 AM PST (16:00 UTC) - Early Bird
    - cron: '0 16 * * *'
    
    # 11:00 AM PST (19:00 UTC) - Morning Recon
    - cron: '0 19 * * *'
    
    # CRUNCH TIME (3-8pm PST every 30 min)
    # 3:00 PM PST (23:00 UTC)
    - cron: '0 23 * * *'
    # 3:30 PM PST (23:30 UTC)
    - cron: '30 23 * * *'
    # 4:00 PM PST (00:00 UTC next day)
    - cron: '0 0 * * *'
    # 4:30 PM PST (00:30 UTC)
    - cron: '30 0 * * *'
    # 5:00 PM PST (01:00 UTC)
    - cron: '0 1 * * *'
    # 5:30 PM PST (01:30 UTC)
    - cron: '30 1 * * *'
    # 6:00 PM PST (02:00 UTC)
    - cron: '0 2 * * *'
    # 6:30 PM PST (02:30 UTC)
    - cron: '30 2 * * *'
    # 7:00 PM PST (03:00 UTC)
    - cron: '0 3 * * *'
    # 7:30 PM PST (03:30 UTC)
    - cron: '30 3 * * *'
    # 8:00 PM PST (04:00 UTC)
    - cron: '0 4 * * *'
    
    # LATE NIGHT / POST-GAME (9pm - 11:30pm PST)
    # 9:00 PM PST (05:00 UTC)
    - cron: '0 5 * * *'
    # 10:00 PM PST (06:00 UTC)
    - cron: '0 6 * * *'
    # 11:00 PM PST (07:00 UTC) - Final Nightly Run
    - cron: '0 7 * * *'

  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  run-prophet-automation:
    runs-on: ubuntu-latest
    
    env:
      BBM_USER: ${{ secrets.BBM_USER }}
      BBM_PASS: ${{ secrets.BBM_PASS }}
      MARKET_API_KEY: ${{ secrets.MARKET_API_KEY }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for proper commits
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        id: install
        run: npm install

      # Removed redundant 'git pull origin main' to avoid conflicts

      - name: Run Prophet Workflow
        id: run_script
        run: node scripts/daily_workflow.js
        continue-on-error: false
      
      - name: Commit & Push Results
        if: always()
        run: |
          git config --global user.name "Prophet Bot"
          git config --global user.email "bot@prop-prophet.com"
          
          # Check for install failure
          if [ "${{ steps.install.outcome }}" == "failure" ]; then
            echo "âŒ CRITICAL: npm install failed" > last_run_error.txt
          fi
          
          # Access last_run_error.txt (create if missing)
          touch last_run_error.txt
          
          git add latest_picks_live.js history/prophet_history.json ease_rankings.json last_run_error.txt
          git diff --staged --quiet || git commit -m "ğŸ¤– Auto-Update: $(date +'%Y-%m-%d %H:%M PST')"
          git pull --rebase origin main
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Workflow Summary
        if: success()
        run: |
          echo "âœ… Prophet automation completed successfully!"
          echo "ğŸ“Š Updated picks pushed to GitHub"
          echo "ğŸš€ Vercel will auto-deploy in ~1 minute"
      
      - name: Error Notification
        if: failure()
        run: |
          echo "âŒ Prophet automation failed!"
          echo "Check last_run_error.txt or logs details"
