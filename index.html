<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prop Prophet v3.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            margin: 0;
            padding: 20px;
        }

        .navbar {
            background: #1e293b;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #10b981;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .login-box {
            max-width: 400px;
            margin: 5rem auto;
            background: #1e293b;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 14px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: black;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background 0.2s;
        }

        button:hover {
            background: #059669;
        }

        .pick-card {
            background: #1e293b;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stat-badge {
            background: #10b981;
            color: black;
            padding: 6px 18px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }

        .edge {
            font-size: 1.8rem;
            color: #10b981;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
        }

        .alert-success {
            background: #10b98120;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #ef444420;
            border: 1px solid #ef4444;
        }

        h1,
        h2,
        h3 {
            margin: 0;
        }

        .user-greeting {
            font-size: 1.2rem;
        }

        .info-text {
            font-size: 0.9em;
            color: #94a3b8;
            margin-top: 20px;
        }

        .file-upload-area {
            border: 2px dashed #334155;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }

        /* MOBILE RESPONSIVENESS */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .navbar {
                flex-direction: column;
                gap: 15px;
                padding: 1rem;
                text-align: center;
            }

            .navbar h1 {
                font-size: 1.5rem;
            }

            .container {
                margin: 1rem auto;
                padding: 0 10px;
            }

            /* Stack Insights Vertically */
            #insights-container {
                flex-direction: column !important;
            }

            /* Stack Record Banner */
            .record-banner {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            /* Login Box */
            .login-box {
                margin: 2rem auto;
                padding: 1.5rem;
            }

            /* Pick Card Adjustments */
            .pick-card {
                padding: 1rem;
            }

            .stat-badge {
                padding: 4px 12px;
                font-size: 0.9em;
            }

            .edge {
                font-size: 1.4rem;
            }

            /* Hide non-essential desktop elements if needed, or adjust */
        }
    </style>
    <!-- Load Data (Cache Busted via Filename Change) -->
    <script src="latest_picks_live.js?v=4.2"></script>
</head>

<body>
    <!-- LOGIN PAGE -->
    <div id="login-page" class="login-box">
        <h2>üèÄ Prop Prophet v3.0</h2>
        <h3 style="margin-bottom: 1.5rem;">Login</h3>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <div class="info-text">
            <strong>Guest:</strong> guest / prophet
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-page" class="hidden">
        <div class="navbar">
            <h1>Prop Prophet Dashboard</h1>
            <div>
                <span class="user-greeting">Hi, <span id="username-display"></span></span>
                <button onclick="logout()" style="margin-left: 20px; width: auto; padding: 8px 20px;">Logout</button>
            </div>
        </div>

        <div class="container">
            <!-- OWNER-ONLY BBM INPUT -->
            <div id="owner-only" class="hidden">
                <h2>üìä Step 1: Upload BBM File or Paste Data</h2>

                <!-- File Upload -->
                <div class="file-upload-area">
                    <input type="file" id="bbm-file" accept=".xls,.xlsx,.csv" style="padding: 5px;">
                    <button onclick="uploadFile()" style="width: auto; margin-left: 10px;">Upload File</button>
                </div>

                <!-- OR Paste -->
                <div style="margin: 10px 0; font-size: 0.9em; color: #94a3b8; text-align: center;">‚Äî OR paste manually
                    below ‚Äî</div>

                <textarea id="bbm-data" rows="12"
                    placeholder="Copy your entire BBM table (Ctrl+A, Ctrl+C) and paste here..."></textarea>

                <button onclick="generatePicks()" style="margin-top: 10px;">Step 2: Generate Picks</button>
                <button id="publish-btn" onclick="publishPicks()" style="background: #8e44ad; margin-top: 10px;">Step 3:
                    Publish to Netlify üöÄ</button>

                <!-- AUTOMATION CONTROLS -->
                <div style="margin-top: 20px; border-top: 1px solid #334155; padding-top: 15px;">
                    <button onclick="forceUpdate()" style="background: #0ea5e9; width: 100%;">üîÑ Force Live Update
                        (Robot)</button>
                    <p style="font-size: 0.8em; color: #94a3b8; text-align: center; margin-top: 5px;">Downloads Fresh
                        Data & Deploys to Netlify automatically.</p>
                </div>
                <button onclick="clearData()" style="background: #ef4444; margin-top: 10px;">Clear Data</button>
            </div>

            <!-- GUEST CONTROLS -->
            <div id="guest-controls" class="hidden" style="text-align: center; margin-bottom: 20px;">
                <h2>Welcome Guest!</h2>
                <button onclick="refreshGuestData()" style="max-width: 300px; background: #0ea5e9;">üîÑ Refresh Cloud
                    Data</button>
                <p style="font-size: 0.8em; color: #94a3b8; margin-top: 5px;">(System updates hourly on game days)</p>

                <!-- EMAIL SUBSCRIBE FORM -->
                <div
                    style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #334155; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <h3 style="color: #10b981; margin-bottom: 10px;">üìß Get Prophet Locks via Email</h3>
                    <p style="font-size: 0.9em; color: #cbd5e1; margin-bottom: 15px;">Receive an instant alert whenever
                        a new <strong>Prophet Lock</strong> is detected. No spam.</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="email" id="sub-email" placeholder="Enter your email" style="margin: 0;">
                        <button id="sub-btn" onclick="subscribeEmail()"
                            style="width: auto; background: #8b5cf6;">Join</button>
                    </div>
                </div>
            </div>

            <!-- RECORD BANNER -->
            <div id="prophet-record-banner" class="record-banner hidden">
                <div class="record-item">üèÜ Season: <span id="rec-season">0-0 (0%)</span></div>
                <div class="record-item">üîí Locks: <span id="rec-locks">0-0 (0%)</span></div>
                <div class="record-item">üíé Diamonds: <span id="rec-diamond">0-0 (0%)</span></div>
            </div>

            <!-- INSIGHTS & PROFIT CONTAINER -->
            <div id="insights-container" class="hidden"
                style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;">

                <!-- 1. PROPHET METER (Left) -->
                <div
                    style="flex: 1; min-width: 250px; background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid #10b981; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.1;">üí∏</div>
                    <h3 style="color: #10b981; margin: 0 0 10px 0; display: flex; align-items: center;">
                        <span style="font-size: 1.5em; margin-right: 10px;">üíµ</span> The Prophet Meter
                    </h3>
                    <p style="color: #94a3b8; font-size: 0.9em; margin: 0 0 15px 0;">Theoretical Profit betting
                        <strong>$100</strong> on every LOCK.
                    </p>
                    <div style="font-size: 2.2em; font-weight: bold; color: #fff;">
                        <span id="profit-display" style="color: #4ade80;">$0.00</span>
                    </div>
                    <div style="font-size: 0.8em; color: #64748b; margin-top: 5px;">(Based on -110 odds: +$90.91 /
                        -$100)</div>
                </div>

                <!-- 2. TIER LEGEND (Middle) -->
                <div
                    style="flex: 1.2; min-width: 280px; background: linear-gradient(135deg, #4b5563, #1f2937); border-left: 5px solid #8b5cf6; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                    <h3 style="color: #a78bfa; margin: 0 0 10px 0; display: flex; align-items: center;">
                        <span style="font-size: 1.5em; margin-right: 10px;">üè∑Ô∏è</span> Pick Tiers
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 5px; font-size: 0.9em; color: #e2e8f0;">
                        <div>üîí <strong>Prophet Lock</strong>: Prophet Tier (> 10.5)</div>
                        <div>üíé <strong>Diamond</strong>: A Boy's Best Friend (9.0 - 10.5)</div>
                        <div>üî• <strong>Elite</strong>: Quality Tested (8.0 - 9.0)</div>
                        <div>üí™ <strong>Strong</strong>: Good But Wouldn't Bet (7.0 - 8.0)</div>
                        <div>‚úÖ <strong>Solid Play</strong>: Data Farming Play (4.0 - 7.0)</div>
                    </div>
                </div>

                <!-- 3. PROPHET WISDOM (Right) -->
                <div
                    style="flex: 1.2; min-width: 280px; background: linear-gradient(135deg, #374151, #111827); border-left: 5px solid #f59e0b; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                    <h3 style="color: #f59e0b; margin: 0 0 10px 0; display: flex; align-items: center;">
                        <span style="font-size: 1.5em; margin-right: 10px;">üîÆ</span> Wisdom
                    </h3>
                    <p id="daily-wisdom"
                        style="font-size: 1.05em; line-height: 1.5; color: #e2e8f0; font-style: italic;">
                        "Loading wisdom..."
                    </p>
                </div>
            </div>

            <style>
                .record-banner {
                    display: flex;
                    justify-content: center;
                    gap: 20px;
                    background: linear-gradient(135deg, #1e293b, #0f172a);
                    padding: 15px;
                    border-radius: 12px;
                    margin-bottom: 25px;
                    border: 1px solid #334155;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    flex-wrap: wrap;
                }

                .record-item {
                    font-size: 1.1em;
                    font-weight: bold;
                    color: #e2e8f0;
                }

                .record-item span {
                    color: #4ade80;
                }
            </style>

            <!-- PICKS DISPLAY -->
            <h2>üéØ Today's Top Picks <span style="font-size: 0.6em;">(<span id="pick-count">0</span> qualifying)</span>
            </h2>
            <div id="alerts"></div>
            <div id="picks-container"></div>
        </div>
    </div>

    <script>
        // Login System
        const API_BASE_URL = 'http://localhost:3000';
        let currentUser = null;
        let currentPicks = [];

        async function refreshGuestData() {
            const btn = document.querySelector('button[onclick="refreshGuestData()"]');
            const originalText = btn ? btn.innerHTML : '';

            // Disable button and show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Triggering Full Refresh...';
            }

            showAlert('info', 'üöÄ Triggering full Prophet workflow (BBM + Odds + Scoring)...');

            try {
                // Trigger the furkflow
                const resp = await fetch('/api/trigger-workflow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (resp.ok) {
                    const data = await resp.json();
                    showAlert('success', `‚úÖ ${data.message}`);

                    // Show countdown and auto-reload after 3 minutes
                    if (btn) btn.innerHTML = '‚è≥ Generating picks (~3 min)...';

                    let secondsLeft = 180; // 3 minutes
                    const countdown = setInterval(() => {
                        secondsLeft--;
                        if (btn) btn.innerHTML = `‚è≥ Refreshing in ${Math.floor(secondsLeft / 60)}:${(secondsLeft % 60).toString().padStart(2, '0')}...`;

                        if (secondsLeft <= 0) {
                            clearInterval(countdown);
                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = originalText;
                            }
                            // Reload the static file to get updated picks
                            const old = document.querySelector('script[src*="latest_picks_live.js"]');
                            if (old) old.remove();
                            const script = document.createElement('script');
                            script.src = 'latest_picks_live.js?t=' + Date.now();
                            script.onload = () => {
                                if (window.LATEST_PICKS) {
                                    currentPicks = window.LATEST_PICKS;
                                    displayPicks(window.LATEST_PICKS);
                                    showAlert('success', `‚úÖ Fresh picks loaded! (${window.LATEST_PICKS.length} total)`);
                                }
                            };
                            document.body.appendChild(script);
                        }
                    }, 1000);

                    return; // Exit early - countdown handles the rest
                } else {
                    const errData = await resp.json();
                    throw new Error(errData.message || 'Failed to trigger workflow');
                }
            } catch (err) {
                console.log('Workflow trigger failed:', err.message);
                showAlert('warning', '‚ö†Ô∏è Full refresh unavailable. Loading cached picks...');
            }

            // Fallback: Reload static file (for non-Vercel or if function fails)
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }

            const old = document.querySelector('script[src*="latest_picks_live.js"]');
            if (old) old.remove();

            const script = document.createElement('script');
            script.src = 'latest_picks_live.js?t=' + Date.now();
            script.onload = () => {
                if (window.LATEST_PICKS) {
                    currentPicks = window.LATEST_PICKS;
                    displayPicks(window.LATEST_PICKS);

                    let msg = `Loaded ${window.LATEST_PICKS.length} picks.`;
                    if (window.LAST_UPDATED) {
                        msg += ` (Updated: ${window.LAST_UPDATED})`;
                    }
                    showAlert('success', msg);
                } else {
                    showAlert('error', 'No data found in cloud file.');
                }
            };
            script.onerror = () => showAlert('error', 'Failed to load cloud file.');
            document.body.appendChild(script);
        }

        async function subscribeEmail() {
            const emailInput = document.getElementById('sub-email');
            const email = emailInput.value.trim();

            if (!email || !email.includes('@')) {
                showAlert('warning', 'Please enter a valid email address.');
                return;
            }

            const btn = document.getElementById('sub-btn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Joining...';

            try {
                const resp = await fetch('/api/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await resp.json();

                if (resp.ok) {
                    showAlert('success', '‚úÖ You are subscribed! Watch your inbox.');
                    emailInput.value = '';
                } else {
                    throw new Error(data.message || 'Subscription failed');
                }
            } catch (err) {
                console.error(err);
                showAlert('warning', `‚ö†Ô∏è ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if ((username === 'owner' && password === 'Reempicks1!') ||
                (username === 'guest' && password === 'prophet')) {
                currentUser = username;
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('dashboard-page').classList.remove('hidden');
                document.getElementById('username-display').textContent = username;

                if (username === 'owner') {
                    document.getElementById('owner-only').classList.remove('hidden');
                } else if (username === 'guest') {
                    document.getElementById('guest-controls').classList.remove('hidden');

                    // CRITICAL: Guests cannot generate (Server is offline for them). Hide inputs.
                    const inputSec = document.getElementById('input-section');
                    if (inputSec) inputSec.style.display = 'none';

                    // GUEST LOGIC: Auto-load static picks
                    if (typeof window.LATEST_PICKS !== 'undefined' && window.LATEST_PICKS.length > 0) {
                        displayPicks(window.LATEST_PICKS);
                        showAlert('success', 'Viewing latest published picks.');
                    } else {
                        showAlert('warning', 'Picks have not been published yet. Please check back later. (v4.0)');
                    }
                }

                showAlert('success', `Welcome, ${username}!`);
            } else {
                showAlert('error', 'Invalid username or password');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('dashboard-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('owner-only').classList.add('hidden');
            document.getElementById('guest-controls').classList.add('hidden');
            document.getElementById('picks-container').innerHTML = '';
            document.getElementById('pick-count').textContent = '0';
        }

        function showAlert(type, message) {
            const alerts = document.getElementById('alerts');
            alerts.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { alerts.innerHTML = ''; }, 5000);
        }

        function clearData() {
            document.getElementById('bbm-data').value = '';
            document.getElementById('picks-container').innerHTML = '';
            document.getElementById('pick-count').textContent = '0';
            showAlert('success', 'Data cleared');
        }

        // Upload file to server (owner)
        async function uploadFile() {
            const fileInput = document.getElementById('bbm-file');
            const file = fileInput.files[0];
            if (!file) {
                showAlert('error', 'Please select a file first');
                return;
            }

            const form = new FormData();
            form.append('bbmfile', file, file.name);

            showAlert('success', 'Uploading BBM to server...');
            try {
                const resp = await fetch(`${API_BASE_URL}/api/upload-bbm`, {
                    method: 'POST',
                    headers: { 'Bypass-Tunnel-Reminder': 'true' },
                    body: form
                });
                const data = await resp.json();
                if (!resp.ok) {
                    console.warn(data);
                    showAlert('error', 'Upload failed');
                    return;
                }
                showAlert('success', `Upload successful ‚Äî ${data.count} players saved.`);
            } catch (err) {
                console.error(err);
                showAlert('error', 'Upload failed: ' + err.message);
            }
        }

        async function publishPicks() {
            if (!currentPicks || currentPicks.length === 0) {
                showAlert('error', 'Generate picks first!');
                return;
            }
            try {
                showAlert('success', 'Publishing to latest_picks.js...');
                const resp = await fetch(`${API_BASE_URL}/api/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ picks: currentPicks })
                });
                if (resp.ok) showAlert('success', 'Saved! Now drag your folder to Netlify.');
                else showAlert('error', 'Publish failed.');
            } catch (e) { showAlert('error', 'Error: ' + e.message); }
        }

        // BBM Data Parser & Pick Generator
        async function generatePicks() {
            // First try to load server BBM if available (owner workflow)
            let players = [];

            try {
                const resp = await fetch(`${API_BASE_URL}/api/bbm`, {
                    headers: { 'Bypass-Tunnel-Reminder': 'true' }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data && data.players && data.players.length > 0) {
                        players = data.players;
                        console.log('Using server-stored BBM', players.length);
                    }
                }
            } catch (err) {
                console.warn('Failed to fetch server BBM', err);
            }

            // If no server BBM, fall back to pasted textarea
            // If no server BBM, fall back to pasted textarea
            if (players.length === 0) {
                const bbmText = document.getElementById('bbm-data').value.trim();
                // If just owner-pasting
                if (bbmText) {
                    players = parseBBMFromText(bbmText);
                } else if (!bbmText && currentUser === 'guest') {
                    // Guest tries to generate but server has no data
                    showAlert('error', 'No data loaded by Owner yet.');
                    return;
                } else if (!bbmText) {
                    showAlert('error', 'Please upload or paste BBM data.');
                    return;
                }
            }

            // Build market-line requests
            const requests = [];
            players.forEach(player => {
                if (player.injury && String(player.injury).toLowerCase().includes('out')) return;

                Object.entries(player.projections || {}).forEach(([stat, proj]) => {
                    // FIX: Allow Steals/Blocks/TO < 1.0 (e.g. 0.8 proj vs 0.5 line is huge value)
                    if (proj < 1.0 && stat !== 's' && stat !== 'b' && stat !== 'to') return;
                    requests.push({ player: player.name, team: player.team || '', stat });
                });
            });

            if (requests.length === 0) {
                showAlert('error', 'No valid players/projections found.');
                return;
            }

            // Query backend for market lines (batch)
            let marketLinesMap = {}; // Key: "Player_stat" -> line

            try {
                showAlert('success', 'Fetching market lines from Prop Prophet API...');
                const resp = await fetch(`${API_BASE_URL}/api/market-lines`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Bypass-Tunnel-Reminder': 'true'
                    },
                    body: JSON.stringify({ requests })
                });

                if (!resp.ok) {
                    console.warn('Market lines API responded with', resp.status);
                    showAlert('error', 'Failed to fetch market lines.');
                } else {
                    const data = await resp.json();
                    // Server now does ALL math. We just display results.
                    const serverPicks = data.results || [];
                    currentPicks = serverPicks;
                    displayPicks(serverPicks);
                }
            } catch (err) {
                console.warn('Failed to fetch market lines', err);
                showAlert('error', 'Network error fetching lines.');
            }
        }

        // Removed client-side CalculatePicks - Logic moved to server v1.0 spec

        function displayPicks(picks) {
            const container = document.getElementById('picks-container');
            const count = document.getElementById('pick-count');

            // Guest restrictions
            if (currentUser === 'guest') {
                picks = picks.slice(0, 5); // Max 5 for guest
            }

            container.innerHTML = '';
            count.textContent = picks.length;

            if (picks.length === 0) {
                container.innerHTML = '<div class="alert alert-error">No +EV picks found. (Check terminal logs for matching details).</div>';
                return;
            }

            picks.forEach((pick, index) => {
                const card = document.createElement('div');
                card.className = 'pick-card';
                card.innerHTML = `
                    <h3>${index + 1}. ${pick.player} - ${pick.stat.toUpperCase()} ${pick.side}</h3>
                    <p style="margin: 10px 0;">
                        <span class="stat-badge">${pick.marketLine}</span>
                        <span class="edge">+${pick.edge} units</span>
                    </p>
                    <p><strong>Proj:</strong> ${pick.projection} | <strong>Line:</strong> ${pick.marketLine}</p>
                    <p>
                        <strong>Pos Ease:</strong> <span style="color:${(pick.posEase || 0) > 0 ? '#4ade80' : ((pick.posEase || 0) < 0 ? '#f87171' : '#cbd5e1')}">${((pick.posEase || 0) * 100).toFixed(1)}%</span> | 
                        <strong>Team Ease:</strong> <span style="color:${(pick.teamEase || 0) > 0 ? '#4ade80' : ((pick.teamEase || 0) < 0 ? '#f87171' : '#cbd5e1')}">${((pick.teamEase || 0) * 100).toFixed(1)}%</span>
                    </p>
                    <p><strong>Interpretation:</strong> <em style="color:#cbd5e1">${pick.interpretation ? pick.interpretation.split('|')[0] : 'None'}</em></p>
                    <p><strong>Confidence:</strong> ${(pick.confidence * 100).toFixed(0)}% | <strong>Score:</strong> ${(pick.edge * pick.confidence).toFixed(2)}</p>
                `;
                container.appendChild(card);
            });
        }

        // Simple parser for pasted BBM text client-side fallback
        function parseBBMFromText(bbmText) {
            const lines = bbmText.split('\n');
            // Try to find header line
            let headerIdx = -1;

            // Look for standard BBM pipe format
            headerIdx = lines.findIndex(line => line.includes('|Own|') || (line.includes('|') && line.includes('Name') && line.includes('Team')));

            if (headerIdx === -1) {
                showAlert('error', 'Could not parse text format. Ensure you copy the table with headers.');
                return [];
            }

            const headers = lines[headerIdx].split('|').map(h => h.trim()).filter(Boolean);
            const colIdx = {};
            headers.forEach((h, i) => colIdx[h] = i);

            const players = [];
            for (let i = headerIdx + 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.includes('|')) continue;
                // Re-split strictly 
                const strictValues = line.split('|').map(v => v.trim());
                const actualValues = strictValues.filter(v => v !== '');

                if (actualValues.length < 5) continue;

                const getVal = (name) => {
                    const idx = colIdx[name] !== undefined ? colIdx[name] : -1;
                    if (idx === -1) return null;
                    return actualValues[idx];
                };

                const name = getVal('Name');
                if (!name || name === 'Name') continue;

                players.push({
                    name: name,
                    team: getVal('Team'),
                    pos: (getVal('Pos') || '').split('/')[0],
                    projections: {
                        p: parseFloat(getVal('p')) || 0,
                        '3': parseFloat(getVal('3')) || 0,
                        r: parseFloat(getVal('r')) || 0,
                        a: parseFloat(getVal('a')) || 0,
                        s: parseFloat(getVal('s')) || 0,
                        b: parseFloat(getVal('b')) || 0,
                        to: parseFloat(getVal('to')) || 0
                    },
                    ease: parseFloat(getVal('Ease')) || 0,
                    injury: getVal('Inj') || '',
                    opp: (getVal('Opp') || '').replace('@ ', '')
                });
            }
            return players;
        }

        async function forceUpdate() {
            const btn = document.getElementById('update-lines-btn'); // Assuming button ID
            if (btn) btn.disabled = true;

            showAlert('info', 'Checking for latest cloud data...');

            // Artificial delay to feel like it's working (and allow UI to render)
            await new Promise(r => setTimeout(r, 800));

            // Reload page with cache-busting timestamp
            const url = new URL(window.location.href);
            url.searchParams.set('t', Date.now());
            window.location.href = url.toString();
        }

        function displayPicks(picks) {
            const container = document.getElementById('picks-container');
            const count = document.getElementById('pick-count');

            // Guest restrictions (REMOVED - Full Access)
            // if (currentUser === 'guest') {
            //    picks = picks.slice(0, 5);
            // }

            // Filter Logic (User Request: "Important NOT to show games that have already started")
            picks = picks.filter(p => {
                if (!p.startTime) return true;
                return new Date(p.startTime) > new Date();
            });

            container.innerHTML = '';
            count.textContent = picks.length;

            if (picks.length === 0) {
                container.innerHTML = '<div class="alert alert-error">No active picks found. All games may have started.</div>';
                return;
            }



            picks.forEach((pick, index) => {
                const card = document.createElement('div');
                card.className = 'pick-card';

                // Elite/Lock Styling Check
                const isLock = pick.betRating.includes("LOCK");
                const isElite = pick.interpretation && pick.interpretation.includes('[ELITE]');

                if (isLock) {
                    card.style.border = "3px solid #e056fd"; // Neon Purple
                    card.style.boxShadow = "0 0 25px rgba(224, 86, 253, 0.6)";
                }

                // Time Logic
                let timeHtml = '';
                if (pick.startTime) {
                    const start = new Date(pick.startTime);
                    const now = new Date();
                    const diffMs = start - now;

                    // Format PST Time
                    const timeStr = start.toLocaleTimeString('en-US', {
                        timeZone: 'America/Los_Angeles',
                        hour: 'numeric',
                        minute: '2-digit'
                    }) + ' PST';

                    // Countdown
                    let countdownStr = '';
                    if (diffMs > 0) {
                        const hrs = Math.floor(diffMs / 3600000);
                        const mins = Math.floor((diffMs % 3600000) / 60000);
                        countdownStr = `<span style="color:#fcd34d; font-weight:bold;">Starts in ${hrs}h ${mins}m</span>`;
                    } else {
                        countdownStr = `<span style="color:#ef4444; font-weight:bold;">LIVE / STARTED</span>`;
                    }

                    // HEADER Time HTML
                    timeHtml = `<div style="font-size:0.8em; color:#e2e8f0; margin-top:2px;">
                        ‚è∞ ${timeStr} ‚Ä¢ ${countdownStr}
                    </div>`;
                }

                card.innerHTML = `
                    <h3>${index + 1}. ${pick.player} - ${pick.stat.toUpperCase()} ${pick.side}</h3>
                    <p style="margin: 10px 0;">
                        <span class="stat-badge">${pick.marketLine}</span>
                        <span class="edge">+${pick.edge} units</span>
                    </p>
                    <p><strong>Proj:</strong> ${pick.projection} | <strong>Line:</strong> ${pick.marketLine}</p>
                    <p><strong>Ease:</strong> ${pick.ease > 0 ? '+' : ''}${pick.ease}</p>
                    <p><strong>Interpretation:</strong> <em style="color:#cbd5e1">${pick.interpretation || 'None'}</em></p>
                    <p><strong>Confidence:</strong> ${(pick.confidence * 100).toFixed(0)}% | <strong>Score:</strong> ${(pick.edge * pick.confidence).toFixed(2)}</p>
                `;
                if (!isLock && isElite) {
                    card.style.border = "2px solid #ffd700";
                    card.style.boxShadow = "0 0 15px rgba(255, 215, 0, 0.3)";
                }

                // Bet Rating Styling
                let badgeBg = "linear-gradient(135deg, #636e72, #b2bec3)"; // Default Playable (Gray)
                if (pick.betRating.includes("LOCK")) badgeBg = "linear-gradient(135deg, #8e44ad, #e056fd)"; // Mystic Purple
                else if (pick.betRating.includes("DIAMOND")) badgeBg = "linear-gradient(135deg, #00cec9, #74b9ff)"; // Cyan/Blue
                else if (pick.betRating.includes("ELITE")) badgeBg = "linear-gradient(135deg, #f1c40f, #e67e22)"; // Gold/Orange
                else if (pick.betRating.includes("STRONG")) badgeBg = "linear-gradient(135deg, #2ecc71, #27ae60)"; // Green
                else if (pick.betRating.includes("SOLID")) badgeBg = "linear-gradient(135deg, #3498db, #2980b9)"; // Blue

                // Stat Name Mapping
                // Stat Name Mapping
                const statMap = {
                    'p': 'Points', 'r': 'Rebounds', 'a': 'Assists', '3': 'Threes', 's': 'Steals', 'b': 'Blocks', 'to': 'Turnovers',
                    'pr': 'Pts+Reb', 'pa': 'Pts+Ast', 'ra': 'Reb+Ast', 'pra': 'Pts+Reb+Ast'
                };
                const statLabel = statMap[pick.stat] || pick.stat.toUpperCase();

                // Side Color Coding (Red for Under)
                const isUnder = pick.side === 'UNDER';
                const sideBg = isUnder
                    ? "linear-gradient(135deg, #e74c3c, #c0392b)" // Red for Under
                    : "linear-gradient(135deg, #2ecc71, #27ae60)"; // Green for Over

                card.innerHTML = `
                    <div class="pick-header">
                        <div style="flex: 1;">
                            <h3 style="margin:0;">${index + 1}. ${pick.player} <small>(${pick.team} - ${pick.pos})</small></h3>
                            ${timeHtml}
                        </div>
                        <div class="pick-badge" style="background: ${badgeBg}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; margin-left: 10px;">
                            ${pick.betRating} | üíé ${pick.score} Rating
                        </div>
                    </div>
                    
                    </div>
                    
                    <div class="pick-stat-row">
                         <span style="background: ${sideBg}; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 1.1em; display: inline-block;">
                            ${statLabel} ${pick.side}
                         </span>
                         <div style="font-size: 1.1em;">
                             <span style="font-weight: bold; margin-left: 5px;">${pick.line}</span>
                             <span style="color: #94a3b8; font-size: 0.9em;">(Proj: ${pick.projection})</span>
                             <span style="color: #28a745; font-weight: bold; margin-left: 5px;">+${pick.edge} Edge</span>
                         </div>
                    </div>
                    


                    <div style="background: #2b2b2b; color: #ecf0f1; padding: 12px; border-radius: 8px; font-size: 0.95em; border: 1px solid #444; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);">

                        <div style="margin-bottom: 5px; display: flex; justify-content: space-between;">
                            <strong>‚öîÔ∏è VS ${pick.opp}</strong> 
                            <span style="color: ${pick.ease > 0 ? '#00e676' : '#ff5252'}; font-weight: bold;">Ease: ${(pick.ease * 100).toFixed(1)}%</span>
                        </div>

                        ${(pick.posEase !== undefined && pick.teamEase !== undefined) ? `
                        <div style="display: flex; gap: 10px; margin-bottom: 8px; font-size: 0.9em; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;">
                            <div style="flex: 1; text-align: center; border-right: 1px solid #444;">
                                <span style="color:#aaa;">Pos Ease</span><br>
                                <span style="font-weight:bold; color: ${pick.posEase > 0 ? '#4ade80' : (pick.posEase < 0 ? '#f87171' : '#cbd5e1')}">${(pick.posEase * 100).toFixed(1)}%</span>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <span style="color:#aaa;">Team Ease</span><br>
                                <span style="font-weight:bold; color: ${pick.teamEase > 0 ? '#4ade80' : (pick.teamEase < 0 ? '#f87171' : '#cbd5e1')}">${(pick.teamEase * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                        ` : ''}

                        <p style="margin: 0; font-style: italic; opacity: 0.9;">${pick.interpretation}</p>
                        
                        <!-- DEEP INSIGHTS -->
                         <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #555; font-size: 0.9em; line-height: 1.5; color: #d1d5db;">
                             <div style="color: #60a5fa; font-weight:bold; margin-bottom:4px; font-size: 1.0em;">üí° Prophet's Breakdown:</div>
                             ${pick.analysis || 'No specific insights available.'}
                        </div>
                    </div>
                    
                         <div style="margin-top: 10px; font-size: 0.9em; display: flex; justify-content: space-between;">
                             <span>Confidence:</span>
                             <span style="color: #f1c40f; font-weight: bold;">
                                ${pick.confidenceGrade || 'B'} <small>(${(pick.confidence * 100).toFixed(0)}%)</small>
                             </span>
                         </div>
                `;
                container.appendChild(card);
            });
        }

        // NEW: Function to update the record banner from window.PROPHET_RECORD
        function updateRecordDisplay() {
            const rec = window.PROPHET_RECORD;
            if (!rec) return;

            // Helper to format record
            const fmt = (r) => `${r.w}-${r.l}-${r.p} (${r.pct}%)`;

            const setEl = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val;
            };

            setEl('rec-season', fmt(rec.season));
            setEl('rec-locks', fmt(rec.locks));
            setEl('rec-diamond', fmt(rec.diamond));

            // Show the banner if it was hidden
            const banner = document.getElementById('prophet-record-banner');
            if (banner) banner.classList.remove('hidden');
        }

        // Call on load if data exists
        if (typeof window.PROPHET_RECORD !== 'undefined') {
            updateRecordDisplay();
            updateProfitMeter();
        }
        // Initialize Wisdom
        initWisdom();

        function updateProfitMeter() {
            const locks = window.PROPHET_RECORD.locks;
            if (!locks) return;

            // Calc: Wins * 90.91 - Losses * 100
            const profit = (locks.w * 90.91) - (locks.l * 100);

            const el = document.getElementById('profit-display');
            if (el) {
                const sign = profit >= 0 ? '+' : '-';
                const color = profit >= 0 ? '#4ade80' : '#f87171'; // Green or Red
                // Format with commas
                const val = Math.abs(profit).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                el.innerHTML = `<span style="color:${color}">${sign}$${val}</span>`;
            }

            document.getElementById('insights-container').classList.remove('hidden');
        }

        function initWisdom() {
            const tips = [
                "In general, trust the early projections. If you see a 'Prophet Lock' or 'Diamond' the night before, it is often the best price you will get. Waiting until tip-off usually means you are betting into a sharper, tougher market.",
                "Never bet more than 1-2% of your bankroll on a single play. Longevity is the key to profit in this game.",
                "Volume is your friend. The more +EV bets you place over time, the faster the math works in your favor to overcome variance.",
                "Don't chase losses. If you have a bad day, stick to the system. The edge will return.",
                "Always shop for lines. Getting -110 vs -120 adds up to massive profit differences over the course of a season.",
                "Beware of 'Narrative' bets. The numbers don't care about a player's birthday or 'revenge game'. Trust the data.",
                "If a player is questionable, wait for confirmation. A late scratch can ruin an entire parlay if you aren't careful.",
                "The Prophet Model loves 'Unders' on players with inflated lines due to recent hot streaks. Regression to the mean is powerful."
            ];

            // Select based on Day of Month
            const day = new Date().getDate();
            const tipIndex = day % tips.length;

            const el = document.getElementById('daily-wisdom');
            if (el) el.innerText = `"${tips[tipIndex]}"`;
        }
    </script>

    <div style="text-align: center; color: #475569; font-size: 0.8em; margin-top: 50px; cursor: pointer;"
        onclick="secretAdminUpdate()">
        Prop Prophet v4.0 - ¬© 2026
    </div>

    <script>
        // ... previous code ...

        function secretAdminUpdate() {
            const pass = prompt("üîê Admin Override: Enter Password to Force Update:");
            if (pass === 'Reempicks1!') {
                // Bypass the confirm inside forceUpdate by calling logic directly or just handle the confirm
                // Actually forceUpdate has a confirm.
                // Let's modify forceUpdate to accept a 'skipConfirm' arg, or just let him confirm again.
                forceUpdate();
            } else if (pass) {
                alert("‚ùå Access Denied");
            }
        }
    </script>
    <div style="text-align:center; padding: 20px; font-size: 0.8rem; color: #64748b;">
        &copy; 2025 Prop Prophet | System Version: 1.1 (Ease %)
    </div>
</body>

</html>